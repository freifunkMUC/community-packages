checkuplink
#!/bin/busybox sh

# fail fast and abort early
set -eu
# set -o pipefail # TODO: pipefail needs more rework in the script

if { set -C; true 2>/dev/null >/var/lock/checkuplink.lock; }; then
	trap "rm -f /var/lock/checkuplink.lock" EXIT
else
	echo "Lock file exists... exiting"
	exit
fi

source /lib/gluon/gluon-mesh-wireguard-vxlan/functions.sh
init_vars


check_mesh_vpn


check_wireguardkey

# Check connectivity to supernode
if is_connected; then
	# We have a connection, we are done
	exit 0
fi

logger -t checkuplink "Reconnecting ..."

check_NTP

# Delete Interfaces
{
	ip link set nomaster dev mesh-vpn >/dev/null 2>&1
	ip link delete dev mesh-vpn >/dev/null 2>&1
} || true
ip link delete dev "${MESH_VPN_IFACE}" >/dev/null 2>&1 || true

if is_loadbalancing_enabled; then
	# Use /api/v2, get gateway peer details from broker response
	logger -p info -t checkuplink "Loadbalancing enabled."
	use_api_v2

else
	# Use /api/v1, get gateway peer details from config
	logger -p info -t checkuplink "Loadbalancing disabled."
	use_api_v1
fi

logger -p info -t checkuplink "Connecting to $PEER_HOST($PEER_ENDPOINT)"


setup_connection
